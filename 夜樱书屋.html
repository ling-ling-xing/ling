<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="referrer" content="no-referrer">
    <title>夜樱书屋 - 小说搜索下载</title>
    <script id="FileSaver.js" src="https://s4.zstatic.net/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script id="moment.js" src="https://s4.zstatic.net/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
    <script id="lodash.js" src="https://s4.zstatic.net/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script id="jszip" src="https://s4.zstatic.net/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script id="gbk.js">
    'use strict' 
    let table 
    function initGbkTable() { 
        var r, t, e, o, n = new Uint16Array(23940) 
        let f = 0 
        for ([r, t, e, o] of [ 
            [161, 169, 161, 254], 
            [176, 247, 161, 254], 
            [129, 160, 64, 254], 
            [170, 254, 64, 160], 
            [168, 169, 64, 160], 
            [170, 175, 161, 254], 
            [248, 254, 161, 254], 
            [161, 167, 64, 160], 
        ]) 
        for (let l = e; l <= o; l++) 
            if (127 !== l) 
                for (let e = r; e <= t; e++) 
                    n[f++] = (l << 8) | e 
        ;(table = new Uint16Array(65536)).fill(65535) 
        var l = new TextDecoder('gbk').decode(n) 
        for (let e = 0; e < l.length; e++) 
            table[l.charCodeAt(e)] = n[e] 
    } 
    const NodeJsBufAlloc = 'function' == typeof globalThis.Buffer && Buffer.allocUnsafe, defaultOnAlloc = NodeJsBufAlloc ? e => NodeJsBufAlloc(e) : e => new Uint8Array(e), defaultOnError = () => 63 
    window.encodeGBK = function (l, e = {}) { 
        table || initGbkTable() 
        var r = e.onAlloc || defaultOnAlloc, t = e.onError || defaultOnError, o = r(2 * l.length) 
        let n = 0 
        for (let e = 0; e < l.length; e++) { 
            var f = l.charCodeAt(e) 
            if (f < 128) o[n++] = f 
            else { 
                var a = table[f] 
                if (65535 !== a) (o[n++] = a), (o[n++] = a >> 8) 
                else if (8364 === f) o[n++] = 128 
                else { 
                    a = t(e, l) 
                    if (-1 === a) break 
                    255 < a ? ((o[n++] = a), (o[n++] = a >> 8)) : (o[n++] = a) 
                } 
            } 
        } 
        return o.subarray(0, n) 
    }
    </script>
    <script id="epub-saver.js" src="./mtp/ebook/llepub-latest.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body data-theme="dark">
    <!-- 夜间模式遮罩 -->
    <div class="night-overlay"></div>
    
    <!-- 樱花飘落效果 -->
    <div class="sakura-container"></div>
    
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="nav-brand">
            <i class="fas fa-moon"></i>
            <h1>夜樱书屋</h1>
        </div>
        <div class="nav-controls">
            <button class="theme-switch" onclick="toggleTheme()">
                <i class="fas fa-sun" id="sun-icon"></i>
                <i class="fas fa-moon" id="moon-icon"></i>
            </button>
        </div>
    </nav>

    <div class="main-container">
        <!-- 搜索区域 -->
        <div class="search-section">
            <div class="search-card">
                <div class="search-header">
                    <div class="search-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="search-type-tabs">
                        <div class="search-tab active" data-type="book">
                            <i class="fas fa-book"></i> 小说搜索
                        </div>
                        <div class="search-tab" data-type="audio">
                            <i class="fas fa-headphones"></i> 听书搜索
                        </div>
                    </div>
                </div>
                
                <div class="search-main">
                    <div class="search-input-wrapper">
                        <input type="text" id="book-search" placeholder="输入小说名称、作者或书籍ID..." class="search-input">
                        <button id="search-btn" class="search-btn">
                            <i class="fas fa-search"></i> 搜索
                        </button>
                    </div>
                    
                    <div class="advanced-options">
                        <div class="option-row">
                            <div class="option-group">
                                <label><i class="fas fa-file-lines"></i> 下载类型</label>
                                <select id="type-selector" class="styled-select">
                                    <option value="text">文本小说</option>
                                    <option value="audio">音频听书</option>
                                </select>
                            </div>
                            <div class="option-group">
                                <label><i class="fas fa-font"></i> 文本编码</label>
                                <select id="charset-selector" class="styled-select">
                                    <option value="utf-8">UTF-8</option>
                                    <option value="gbk">GBK</option>
                                </select>
                            </div>
                            <div class="option-group">
                                <label><i class="fas fa-file-export"></i> 输出格式</label>
                                <select id="format-selector" class="styled-select">
                                    <option value="txt">TXT文档</option>
                                    <option value="epub">EPUB电子书</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="chapter-range-section">
                            <h4><i class="fas fa-list-ol"></i> 章节范围设置</h4>
                            <div class="range-inputs">
                                <div class="range-group">
                                    <label>开始章节</label>
                                    <input type="number" id="start-chapter" min="1" placeholder="默认为1" class="range-input">
                                </div>
                                <div class="range-group">
                                    <label>结束章节</label>
                                    <input type="number" id="end-chapter" min="1" placeholder="默认为最后一章" class="range-input">
                                </div>
                                <div class="range-group">
                                    <label>每批数量</label>
                                    <select id="batch-size" class="styled-select small">
                                        <option value="50">50章/批</option>
                                        <option value="100" selected>100章/批</option>
                                        <option value="200">200章/批</option>
                                        <option value="500">500章/批</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主内容区域 -->
        <div class="content-area">
            <!-- 左侧：搜索结果 -->
            <div class="results-section">
                <div class="section-header">
                    <h3><i class="fas fa-books"></i> 搜索结果</h3>
                    <span id="results-count" class="count-badge">0 本</span>
                </div>
                <div id="book-list" class="books-grid"></div>
            </div>

            <!-- 右侧：书籍详情 -->
            <div id="book-info" class="detail-section">
                <div class="detail-card">
                    <div class="detail-header">
                        <h2 id="book-title" class="book-title">选择书籍查看详情</h2>
                        <button class="detail-action" onclick="showBookActions()">
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                    </div>
                    
                    <div class="detail-content">
                        <div class="cover-section">
                            <div class="cover-container">
                                <img src="" alt="封面" id="book-cover" class="book-cover-large">
                                <div class="cover-glow"></div>
                            </div>
                            
                            <div class="action-buttons">
                                <button class="action-btn primary" onclick="downloadBook()">
                                    <i class="fas fa-download"></i> 下载书籍
                                </button>
                                <button class="action-btn secondary" onclick="showChapterRangeModal()">
                                    <i class="fas fa-cog"></i> 设置章节
                                </button>
                                <button class="action-btn danger" onclick="clearBookInfo()">
                                    <i class="fas fa-trash"></i> 清空
                                </button>
                            </div>
                        </div>
                        
                        <div class="info-section">
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label"><i class="fas fa-user-pen"></i> 作者</span>
                                    <span id="book-author" class="info-value">未知作者</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label"><i class="fas fa-tag"></i> 分类</span>
                                    <span id="book-category" class="info-value">未知分类</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label"><i class="fas fa-hourglass-half"></i> 状态</span>
                                    <span id="creation-status" class="info-value status-badge">未知</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label"><i class="fas fa-hashtag"></i> 字数</span>
                                    <span id="word-count" class="info-value">0字</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label"><i class="fas fa-book-open"></i> 总章节</span>
                                    <span id="total-chapters" class="info-value">0章</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label"><i class="fas fa-eye"></i> 读者数</span>
                                    <span id="readers-count" class="info-value">0</span>
                                </div>
                            </div>
                            
                            <div class="latest-chapter-box">
                                <div class="box-header">
                                    <i class="fas fa-file-lines"></i> 最新章节
                                </div>
                                <div class="box-content">
                                    <p id="latest-chapter" class="chapter-title">暂无章节信息</p>
                                    <p id="latest-chapter-passtime" class="chapter-time"></p>
                                </div>
                            </div>
                            
                            <div class="description-box">
                                <div class="box-header">
                                    <i class="fas fa-align-left"></i> 书籍简介
                                </div>
                                <div class="box-content scrollable">
                                    <p id="book-description" class="description-text">选择书籍后，这里将显示书籍的详细简介内容...</p>
                                </div>
                            </div>
                            
                            <div class="download-history">
                                <div class="box-header">
                                    <i class="fas fa-history"></i> 下载历史
                                    <button class="clear-history" onclick="clearDownloadHistory()">
                                        <i class="fas fa-trash-alt"></i> 清空
                                    </button>
                                </div>
                                <div id="history-list" class="history-content">
                                    <p class="empty-history">暂无下载记录</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 隐藏数据 -->
                    <div class="hidden-data">
                        <p id="book_id" style="display: none"></p>
                        <p id="book_info" style="display: none"></p>
                        <p id="download_lock" style="display: none"></p>
                        <p id="book_catalog" style="display: none"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 进度条弹窗 -->
    <div id="progress-modal" class="modal-overlay" style="display: none">
        <div class="modal-content large">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-cloud-download-alt"></i>
                </div>
                <h3 id="progress-title">正在下载书籍</h3>
                <button class="modal-close" onclick="hideProgressModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="progress-section">
                    <div class="progress-info">
                        <span id="progress-percentage">0%</span>
                        <span id="progress-count">0/0 章</span>
                    </div>
                    <div class="progress-bar-wrapper">
                        <div id="progress-bar-fill" class="progress-bar-fill"></div>
                    </div>
                    <div class="progress-details">
                        <p id="current-chapter">准备开始下载...</p>
                        <p id="download-speed">速度: --</p>
                    </div>
                </div>
                
                <div id="sub-progress" style="display: none" class="sub-progress-section">
                    <div class="sub-header">
                        <i class="fas fa-layer-group"></i> 批量下载进度
                    </div>
                    <div class="progress-bar-wrapper small">
                        <div id="sub-progress-bar-fill" class="progress-bar-fill"></div>
                    </div>
                    <div class="sub-details">
                        <p id="batch-progress">第 0 批 / 共 0 批</p>
                    </div>
                </div>
                
                <div class="chapter-stats">
                    <div class="stat-item">
                        <span class="stat-label">已下载</span>
                        <span id="downloaded-chapters" class="stat-value">0章</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">失败章节</span>
                        <span id="failed-chapters" class="stat-value">0章</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">预计剩余</span>
                        <span id="time-remaining" class="stat-value">--</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">文件大小</span>
                        <span id="file-size" class="stat-value">--</span>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button id="progress-cancel" class="btn btn-danger" onclick="cancelDownload()">
                    <i class="fas fa-stop-circle"></i> 取消下载
                </button>
                <button id="progress-pause" class="btn btn-warning" onclick="togglePauseDownload()">
                    <i class="fas fa-pause"></i> 暂停
                </button>
                <button id="button-resave" class="btn btn-secondary" style="display: none" onclick="saveManually()">
                    <i class="fas fa-save"></i> 手动保存
                </button>
                <button id="button-redownload" class="btn btn-primary" style="display: none" onclick="reDownloadFile()">
                    <i class="fas fa-redo"></i> 重新下载
                </button>
                <button id="progress-submit" class="btn btn-success" style="display: none" onclick="closeProgressModal()">
                    <i class="fas fa-check"></i> 完成
                </button>
            </div>
        </div>
    </div>

    <!-- 章节范围设置弹窗 -->
    <div id="chapter-modal" class="modal-overlay" style="display: none">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-sliders-h"></i> 章节范围设置</h3>
                <button class="modal-close" onclick="hideChapterModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="range-controls">
                    <div class="range-input-group">
                        <label for="modal-start-chapter">
                            <i class="fas fa-play"></i> 开始章节
                        </label>
                        <input type="number" id="modal-start-chapter" min="1" placeholder="例如: 1" class="modal-range-input">
                    </div>
                    
                    <div class="range-input-group">
                        <label for="modal-end-chapter">
                            <i class="fas fa-stop"></i> 结束章节
                        </label>
                        <input type="number" id="modal-end-chapter" min="1" placeholder="例如: 100" class="modal-range-input">
                    </div>
                </div>
                
                <div class="range-preview">
                    <h4>章节预览</h4>
                    <div id="chapter-preview" class="preview-list">
                        <p class="preview-empty">请输入章节范围后预览</p>
                    </div>
                </div>
                
                <div class="quick-ranges">
                    <h4>快速选择</h4>
                    <div class="quick-buttons">
                        <button class="quick-btn" onclick="setChapterRange(1, 50)">1-50章</button>
                        <button class="quick-btn" onclick="setChapterRange(1, 100)">1-100章</button>
                        <button class="quick-btn" onclick="setChapterRange(1, 200)">1-200章</button>
                        <button class="quick-btn" onclick="selectAllChapters()">全部章节</button>
                        <button class="quick-btn" onclick="selectLatestChapters(50)">最新50章</button>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideChapterModal()">
                    取消
                </button>
                <button class="btn btn-primary" onclick="applyChapterRange()">
                    应用设置
                </button>
                <button class="btn btn-success" onclick="applyAndDownload()">
                    设置并下载
                </button>
            </div>
        </div>
    </div>

    <!-- 书籍详情弹窗 -->
    <dialog id="detail-dialog" class="detail-dialog">
        <div class="dialog-content">
            <div class="dialog-header">
                <h3><i class="fas fa-info-circle"></i> 书籍详细信息</h3>
                <button class="dialog-close" onclick="document.getElementById('detail-dialog').close()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="detail-dialog-content" class="dialog-body"></div>
        </div>
    </dialog>

    <!-- 音频下载设置 -->
    <div id="audio-modal" class="modal-overlay" style="display: none">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-volume-up"></i> 音频下载设置</h3>
                <button class="modal-close" onclick="hideAudioModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="audio-settings">
                    <div class="setting-group">
                        <label>音色选择</label>
                        <select id="audio-tone" class="styled-select">
                            <option value="1">默认音色</option>
                            <option value="2">温柔女声</option>
                            <option value="3">磁性男声</option>
                            <option value="4">可爱童声</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label>音质选择</label>
                        <select id="audio-quality" class="styled-select">
                            <option value="high">高质量 (128kbps)</option>
                            <option value="standard" selected>标准质量 (64kbps)</option>
                            <option value="low">节省流量 (32kbps)</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label>输出格式</label>
                        <select id="audio-format" class="styled-select">
                            <option value="mp3" selected>MP3格式</option>
                            <option value="m4a">M4A格式</option>
                        </select>
                    </div>
                    <div class="warning-box">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>注意：音频下载可能需要较长时间，建议使用WiFi网络</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideAudioModal()">
                    取消
                </button>
                <button class="btn btn-primary" onclick="startAudioDownload()">
                    开始下载
                </button>
            </div>
        </div>
    </div>

    <!-- 全局通知 -->
    <div id="notification-container"></div>

    <script>
        // 全局变量
        const apiNode = 'http://124.220.210.89:40180'
        let currentBookData = null
        let currentCatalog = []
        let downloadProgress = null
        let isDownloading = false
        let isPaused = false
        let downloadHistory = JSON.parse(localStorage.getItem('download_history') || '[]')
        let failedChapters = []
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initTheme()
            initEventListeners()
            initUI()
            updateHistoryList()
            createSakuraEffect()
            
            // 恢复URL参数
            restoreFromUrlParams()
        })
        
        // 主题功能
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark'
            document.body.dataset.theme = savedTheme
            updateThemeIcon(savedTheme)
        }
        
        function toggleTheme() {
            const currentTheme = document.body.dataset.theme
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark'
            document.body.dataset.theme = newTheme
            localStorage.setItem('theme', newTheme)
            updateThemeIcon(newTheme)
            showNotification(`已切换到${newTheme === 'dark' ? '夜间' : '日间'}模式`)
        }
        
        function updateThemeIcon(theme) {
            const sunIcon = document.getElementById('sun-icon')
            const moonIcon = document.getElementById('moon-icon')
            if (theme === 'dark') {
                sunIcon.style.display = 'none'
                moonIcon.style.display = 'inline'
            } else {
                sunIcon.style.display = 'inline'
                moonIcon.style.display = 'none'
            }
        }
        
        // 初始化事件监听
        function initEventListeners() {
            // 搜索按钮
            document.getElementById('search-btn').addEventListener('click', searchBooks)
            
            // 搜索框回车
            document.getElementById('book-search').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchBooks()
            })
            
            // 搜索类型标签
            document.querySelectorAll('.search-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.search-tab').forEach(t => t.classList.remove('active'))
                    this.classList.add('active')
                })
            })
            
            // 书籍标题点击
            document.getElementById('book-title').addEventListener('click', showBookDetails)
            
            // 监听浏览器前进后退
            window.addEventListener('popstate', restoreFromUrlParams)
        }
        
        // 初始化UI
        function initUI() {
            // 初始化章节范围输入
            const startChapter = document.getElementById('start-chapter')
            const endChapter = document.getElementById('end-chapter')
            
            startChapter.addEventListener('change', validateChapterRange)
            endChapter.addEventListener('change', validateChapterRange)
            
            // 显示初始化完成通知
            setTimeout(() => {
                showNotification('夜樱书屋已准备就绪', 'success')
            }, 1000)
        }
        
        // 验证章节范围
        function validateChapterRange() {
            const start = parseInt(document.getElementById('start-chapter').value) || 1
            const end = parseInt(document.getElementById('end-chapter').value)
            
            if (end && start > end) {
                showNotification('开始章节不能大于结束章节', 'warning')
                document.getElementById('start-chapter').value = 1
            }
        }
        
        // 搜索功能
        async function searchBooks() {
            const query = document.getElementById('book-search').value.trim()
            if (!query) {
                showNotification('请输入搜索内容', 'warning')
                return
            }
            
            const activeTab = document.querySelector('.search-tab.active')
            const type = activeTab ? activeTab.dataset.type : 'book'
            const typeMap = { book: 3, audio: 2 }
            
            // 显示加载状态
            const searchBtn = document.getElementById('search-btn')
            const originalText = searchBtn.innerHTML
            searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 搜索中...'
            searchBtn.disabled = true
            
            // 检查是否为书籍ID
            const bookId = matchId(query)
            if (bookId) {
                updateUrlParams({ book_id: bookId, search_type: type })
                searchBtn.innerHTML = originalText
                searchBtn.disabled = false
                return await showBookInfo(bookId)
            }
            
            updateUrlParams({ text: query, search_type: type })
            
            const url = `${apiNode}/search?query=${encodeURIComponent(query)}&offset=0&tab_type=${typeMap[type]}`
            
            try {
                const response = await fetch(url)
                if (!response.ok) throw new Error(`HTTP ${response.status}`)
                
                const rawData = await response.json()
                const data = normalizeApiResponse(rawData)
                const resp = data.search_tabs?.find(tab => tab.tab_type === typeMap[type])?.data || []
                
                let searchResults = []
                for (let i of resp) {
                    let obj = (i.book_data || [])[0]
                    if (obj) searchResults.push(obj)
                }
                
                displaySearchResults(searchResults)
                showNotification(`找到 ${searchResults.length} 个结果`, 'success')
                
            } catch (error) {
                console.error('搜索失败:', error)
                showNotification('搜索失败，请检查网络连接', 'error')
            } finally {
                searchBtn.innerHTML = originalText
                searchBtn.disabled = false
            }
        }
        
        // 匹配书籍ID
        function matchId(url) {
            const regex = /(?:\/page\/(\d{19})|[\?&]book_id=(\d{19}))/
            const match = url.match(regex)
            if (match || (url.length === 19 && !Number.isNaN(parseInt(url)))) {
                return match ? match[1] || match[2] : url
            }
            return null
        }
        
        // 显示搜索结果
        function displaySearchResults(results) {
            const bookList = document.getElementById('book-list')
            const resultsCount = document.getElementById('results-count')
            
            if (results.length === 0) {
                bookList.innerHTML = `
                    <div class="empty-results">
                        <i class="fas fa-book-open"></i>
                        <h3>没有找到相关书籍</h3>
                        <p>试试其他关键词吧~</p>
                    </div>
                `
                resultsCount.textContent = '0 本'
                return
            }
            
            bookList.innerHTML = ''
            results.forEach((result, index) => {
                const bookItem = document.createElement('div')
                bookItem.className = 'book-item'
                bookItem.dataset.bookId = result.book_id
                
                bookItem.innerHTML = `
                    <div class="book-item-cover">
                        <img src="${result.thumb_url || ''}" 
                             alt="${result.book_name}" 
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgZmlsbD0iIzFlMWUyMyIvPjx0ZXh0IHg9IjE1MCIgeT0iMjI1IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM5YjlmYjMiPk5vIENvdmVyPC90ZXh0Pjwvc3ZnPg=='">
                        <div class="book-rank">${index + 1}</div>
                    </div>
                    <div class="book-item-info">
                        <h3 class="book-item-title">${result.book_name || '未知书名'}</h3>
                        <p class="book-item-author"><i class="fas fa-user-pen"></i> ${result.author || '未知作者'}</p>
                        <div class="book-item-meta">
                            <span class="meta-tag">${result.category || '未知分类'}</span>
                            <span class="meta-tag">${formatCount(result.word_number || 0)}字</span>
                            <span class="meta-tag readers"><i class="fas fa-eye"></i> ${formatCount(result.read_count || 0)}</span>
                        </div>
                        <button class="book-item-action" onclick="showBookInfo('${result.book_id}')">
                            <i class="fas fa-info-circle"></i> 查看详情
                        </button>
                    </div>
                `
                
                bookItem.addEventListener('click', (e) => {
                    if (!e.target.closest('.book-item-action')) {
                        showBookInfo(result.book_id)
                    }
                })
                
                bookList.appendChild(bookItem)
            })
            
            resultsCount.textContent = `${results.length} 本`
            document.getElementById('book-info').style.display = 'none'
        }
        
        // 显示书籍信息
        async function showBookInfo(bookId) {
            if (!bookId) return
            
            try {
                // 获取书籍信息
                const infoUrl = `${apiNode}/info?book_id=${bookId}`
                const infoResponse = await fetch(infoUrl)
                if (!infoResponse.ok) throw new Error(`HTTP ${infoResponse.status}`)
                
                const infoData = await infoResponse.json()
                const bookData = normalizeApiResponse(infoData).data || {}
                
                // 获取目录
                const catalogUrl = `${apiNode}/catalog?book_id=${bookId}`
                const catalogResponse = await fetch(catalogUrl)
                const catalogData = await catalogResponse.json()
                const catalog = normalizeApiResponse(catalogData).data?.item_data_list || []
                
                currentBookData = bookData
                currentCatalog = catalog
                
                // 更新UI
                updateBookInfoUI(bookData, catalog)
                document.getElementById('book_info').textContent = JSON.stringify(bookData)
                document.getElementById('book_catalog').textContent = JSON.stringify(catalog)
                document.getElementById('book_id').textContent = bookId
                
                // 显示详情区域
                document.getElementById('book-info').style.display = 'block'
                
                // 更新URL
                updateUrlParams({ book_id: bookId })
                
                // 显示通知
                showNotification(`已加载《${bookData.book_name}》`, 'success')
                
            } catch (error) {
                console.error('获取书籍信息失败:', error)
                showNotification('获取书籍信息失败', 'error')
            }
        }
        
        // 更新书籍信息UI
        function updateBookInfoUI(bookData, catalog) {
            // 基本信息
            document.getElementById('book-title').textContent = bookData.book_name || '未知标题'
            document.getElementById('book-author').textContent = bookData.author || '未知作者'
            document.getElementById('book-category').textContent = bookData.category || '未知分类'
            document.getElementById('book-description').textContent = bookData.abstract || '暂无简介'
            document.getElementById('word-count').textContent = formatCount(bookData.word_number || 0) + '字'
            document.getElementById('readers-count').textContent = formatCount(bookData.read_count || 0)
            document.getElementById('total-chapters').textContent = catalog.length + '章'
            
            // 封面图片
            const coverImg = document.getElementById('book-cover')
            if (bookData.thumb_url) {
                coverImg.src = bookData.thumb_url
                coverImg.onerror = function() {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgZmlsbD0iIzFlMWUyMyIvPjx0ZXh0IHg9IjE1MCIgeT0iMjI1IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM5YjlmYjMiPk5vIENvdmVyPC90ZXh0Pjwvc3ZnPg=='
                }
            }
            
            // 状态
            const statusMap = ['未知', '完结', '连载', null, null, null, '断更']
            const status = statusMap[bookData.creation_status || 0] || '未知'
            document.getElementById('creation-status').textContent = status
            document.getElementById('creation-status').className = `info-value status-badge status-${status}`
            
            // 最新章节
            document.getElementById('latest-chapter').textContent = bookData.last_chapter_title || '未知'
            if (bookData.last_chapter_first_pass_time) {
                const time = moment(parseInt(bookData.last_chapter_first_pass_time) * 1000).format('YYYY-MM-DD HH:mm:ss')
                document.getElementById('latest-chapter-passtime').textContent = time
            }
        }
        
        // 下载书籍
        async function downloadBook() {
            if (!currentBookData) {
                showNotification('请先选择一本书籍', 'warning')
                return
            }
            
            const type = document.getElementById('type-selector').value
            if (type === 'audio') {
                showAudioModal()
                return
            }
            
            const charset = document.getElementById('charset-selector').value
            const format = document.getElementById('format-selector').value
            
            if (format === 'epub' && charset === 'gbk') {
                showNotification('EPUB格式仅支持UTF-8编码', 'warning')
                document.getElementById('charset-selector').value = 'utf-8'
                return
            }
            
            // 获取章节范围
            const startChapter = parseInt(document.getElementById('start-chapter').value) || 1
            const endChapterInput = document.getElementById('end-chapter').value
            const endChapter = endChapterInput ? parseInt(endChapterInput) : currentCatalog.length
            
            if (startChapter > endChapter) {
                showNotification('开始章节不能大于结束章节', 'error')
                return
            }
            
            if (startChapter < 1 || startChapter > currentCatalog.length) {
                showNotification('开始章节超出范围', 'error')
                return
            }
            
            if (endChapter < 1 || endChapter > currentCatalog.length) {
                showNotification('结束章节超出范围', 'error')
                return
            }
            
            // 获取选中的章节
            const selectedChapters = currentCatalog.slice(startChapter - 1, endChapter)
            if (selectedChapters.length === 0) {
                showNotification('没有可下载的章节', 'warning')
                return
            }
            
            showNotification(`开始下载 ${selectedChapters.length} 个章节`, 'info')
            
            // 显示进度窗口
            downloadProgress = showProgressModal('下载书籍', selectedChapters.length)
            failedChapters = []
            
            // 开始下载
            await downloadChapters(selectedChapters, charset, format)
        }
        
        // 下载章节内容
        async function downloadChapters(chapters, charset, format) {
            if (!downloadProgress) return
            
            const result = {}
            const batchSize = parseInt(document.getElementById('batch-size').value) || 100
            const batches = chunkArray(chapters.map(c => c.item_id), batchSize)
            
            downloadProgress.totalBatches = batches.length
            downloadProgress.currentBatch = 0
            downloadProgress.downloadedCount = 0
            
            // 显示子进度条
            const subProgress = document.getElementById('sub-progress')
            subProgress.style.display = 'block'
            
            for (let i = 0; i < batches.length; i++) {
                if (isPaused) {
                    await waitForResume()
                }
                
                if (downloadProgress.isCancelled) {
                    showNotification('下载已取消', 'info')
                    return
                }
                
                downloadProgress.currentBatch = i + 1
                updateBatchProgress(i + 1, batches.length)
                
                const batch = batches[i]
                try {
                    const batchResult = await downloadChapterBatch(batch)
                    Object.assign(result, batchResult)
                    
                    downloadProgress.downloadedCount += batch.length
                    downloadProgress.updateProgress(downloadProgress.downloadedCount)
                    updateCurrentChapter(chapters[downloadProgress.downloadedCount - 1]?.title)
                    
                } catch (error) {
                    console.error(`第 ${i + 1} 批下载失败:`, error)
                    failedChapters.push(...batch)
                }
                
                // 更新速度估算
                updateDownloadSpeed()
            }
            
            // 处理失败章节重试
            if (failedChapters.length > 0) {
                showNotification(`${failedChapters.length} 个章节下载失败，正在重试...`, 'warning')
                await retryFailedChapters(failedChapters, result)
            }
            
            // 生成文件
            await generateFile(result, chapters, charset, format)
        }
        
        // 批量下载章节
        async function downloadChapterBatch(itemIds) {
            try {
                const response = await fetch(`${apiNode}/batch_chapter`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item_ids: itemIds })
                })
                
                const data = await response.json()
                if (data.code === 0 && data.data) {
                    const result = {}
                    for (const [itemId, itemData] of Object.entries(data.data)) {
                        try {
                            if (typeof itemData === 'string') {
                                const parsed = JSON.parse(itemData)
                                result[itemId] = parsed.data || parsed
                            } else {
                                result[itemId] = itemData.data || itemData
                            }
                        } catch (e) {
                            console.error(`解析章节 ${itemId} 失败:`, e)
                        }
                    }
                    return result
                }
                throw new Error(data.msg || '批量下载失败')
            } catch (error) {
                console.error('批量下载失败:', error)
                throw error
            }
        }
        
        // 重试失败章节
        async function retryFailedChapters(failedIds, result) {
            for (const itemId of failedIds) {
                if (downloadProgress.isCancelled) break
                
                try {
                    const response = await fetch(`${apiNode}/content?item_id=${itemId}`)
                    const data = await response.json()
                    if (data.data?.content) {
                        result[itemId] = data.data
                        failedChapters = failedChapters.filter(id => id !== itemId)
                    }
                } catch (error) {
                    console.error(`重试章节 ${itemId} 失败:`, error)
                }
            }
            
            updateFailedChaptersCount()
        }
        
        // 生成文件
        async function generateFile(chapterData, chapters, charset, format) {
            if (downloadProgress.isCancelled) return
            
            downloadProgress.updateTitle('正在生成文件...')
            
            if (format === 'epub') {
                await generateEpub(chapterData, chapters, charset)
            } else {
                await generateTxt(chapterData, chapters, charset)
            }
            
            // 记录下载历史
            addToDownloadHistory(currentBookData.book_name, chapters.length)
            
            downloadProgress.complete()
            showNotification('下载完成！', 'success')
        }
        
        // 生成TXT文件
        async function generateTxt(chapterData, chapters, charset) {
            let content = `《${currentBookData.book_name}》\n`
            content += `作者：${currentBookData.author}\n`
            content += `分类：${currentBookData.category}\n`
            content += `字数：${formatCount(currentBookData.word_number || 0)}\n`
            content += `状态：${['未知', '完结', '连载'][currentBookData.creation_status || 0] || '未知'}\n`
            content += `简介：${currentBookData.abstract}\n`
            content += `${currentBookData.copyright_info || ''}\n\n`
            content += '='.repeat(50) + '\n\n'
            
            let currentVolume = ''
            for (const chapter of chapters) {
                const data = chapterData[chapter.item_id]
                if (!data) continue
                
                // 处理卷名
                if (data.novel_data?.volume_name && data.novel_data.volume_name !== currentVolume) {
                    currentVolume = data.novel_data.volume_name
                    content += `\n\n${currentVolume}\n\n`
                }
                
                // 添加章节内容
                content += `${chapter.title}\n\n`
                content += htmlToText(data.content || '<p>本章节内容为空</p>') + '\n\n\n'
            }
            
            // 保存文件
            const fileName = `${currentBookData.book_name}_${currentBookData.author}.txt`
            const encoded = charset === 'gbk' ? encodeGBK(content) : new TextEncoder().encode(content)
            const blob = new Blob([encoded], { type: `text/plain;charset=${charset}` })
            
            window.downloadResult = { content, fileName, blob }
            saveAs(blob, fileName)
        }
        
        // 生成EPUB文件
        async function generateEpub(chapterData, chapters, charset) {
            showNotification('EPUB生成功能正在开发中...', 'info')
            // EPUB生成代码需要EpubSaver库，这里先提供TXT作为替代
            await generateTxt(chapterData, chapters, charset)
        }
        
        // HTML转文本
        function htmlToText(html) {
            const div = document.createElement('div')
            div.innerHTML = html
            let text = div.textContent || div.innerText || ''
            
            // 清理多余空白
            text = text.replace(/\s+/g, ' ')
            text = text.replace(/^\s+|\s+$/g, '')
            
            // 添加首行缩进
            return '\u3000\u3000' + text
        }
        
        // 数组分块
        function chunkArray(arr, size) {
            const chunks = []
            for (let i = 0; i < arr.length; i += size) {
                chunks.push(arr.slice(i, i + size))
            }
            return chunks
        }
        
        // 格式化数字
        function formatCount(num) {
            if (!num) return '0'
            if (num >= 100000000) return (num / 100000000).toFixed(1) + '亿'
            if (num >= 10000) return (num / 10000).toFixed(1) + '万'
            return num.toString()
        }
        
        // 显示通知
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container')
            const notification = document.createElement('div')
            notification.className = `notification notification-${type}`
            
            const icons = {
                info: 'info-circle',
                success: 'check-circle',
                warning: 'exclamation-triangle',
                error: 'times-circle'
            }
            
            notification.innerHTML = `
                <i class="fas fa-${icons[type] || 'info-circle'}"></i>
                <span>${message}</span>
            `
            
            container.appendChild(notification)
            
            setTimeout(() => {
                notification.classList.add('show')
            }, 10)
            
            setTimeout(() => {
                notification.classList.remove('show')
                setTimeout(() => {
                    if (notification.parentNode) {
                        container.removeChild(notification)
                    }
                }, 300)
            }, 3000)
        }
        
        // 进度窗口功能
        function showProgressModal(title, total) {
            const modal = document.getElementById('progress-modal')
            modal.style.display = 'flex'
            
            document.getElementById('progress-title').textContent = title
            document.getElementById('progress-count').textContent = `0/${total} 章`
            document.getElementById('progress-percentage').textContent = '0%'
            document.getElementById('progress-bar-fill').style.width = '0%'
            
            // 重置统计信息
            document.getElementById('downloaded-chapters').textContent = '0章'
            document.getElementById('failed-chapters').textContent = '0章'
            document.getElementById('time-remaining').textContent = '--'
            document.getElementById('file-size').textContent = '--'
            document.getElementById('current-chapter').textContent = '准备开始下载...'
            document.getElementById('download-speed').textContent = '速度: --'
            
            const progress = {
                total,
                current: 0,
                startTime: Date.now(),
                isCancelled: false,
                isPaused: false,
                updateTitle(newTitle) {
                    document.getElementById('progress-title').textContent = newTitle
                },
                updateProgress(current) {
                    this.current = current
                    const percentage = Math.round((current / this.total) * 100)
                    document.getElementById('progress-percentage').textContent = percentage + '%'
                    document.getElementById('progress-bar-fill').style.width = percentage + '%'
                    document.getElementById('progress-count').textContent = `${current}/${this.total} 章`
                    document.getElementById('downloaded-chapters').textContent = `${current}章`
                    
                    // 更新剩余时间
                    updateTimeRemaining()
                },
                cancel() {
                    this.isCancelled = true
                    hideProgressModal()
                },
                complete() {
                    document.getElementById('progress-submit').style.display = 'block'
                    document.getElementById('button-resave').style.display = 'block'
                    document.getElementById('button-redownload').style.display = 'block'
                    document.getElementById('progress-cancel').style.display = 'none'
                    document.getElementById('progress-pause').style.display = 'none'
                    this.updateTitle('下载完成！')
                }
            }
            
            return progress
        }
        
        // 更新批量进度
        function updateBatchProgress(current, total) {
            const percentage = Math.round((current / total) * 100)
            document.getElementById('sub-progress-bar-fill').style.width = percentage + '%'
            document.getElementById('batch-progress').textContent = `第 ${current} 批 / 共 ${total} 批`
        }
        
        // 更新当前章节
        function updateCurrentChapter(chapterTitle) {
            if (chapterTitle) {
                document.getElementById('current-chapter').textContent = 
                    `正在下载：${chapterTitle.substring(0, 30)}${chapterTitle.length > 30 ? '...' : ''}`
            }
        }
        
        // 更新失败章节数
        function updateFailedChaptersCount() {
            document.getElementById('failed-chapters').textContent = `${failedChapters.length}章`
        }
        
        // 更新下载速度
        function updateDownloadSpeed() {
            if (!downloadProgress || downloadProgress.current === 0) return
            
            const elapsed = (Date.now() - downloadProgress.startTime) / 1000 // 秒
            const speed = downloadProgress.current / elapsed // 章/秒
            
            document.getElementById('download-speed').textContent = 
                `速度: ${speed.toFixed(1)} 章/秒`
        }
        
        // 更新剩余时间
        function updateTimeRemaining() {
            if (!downloadProgress || downloadProgress.current === 0) return
            
            const elapsed = (Date.now() - downloadProgress.startTime) / 1000 // 秒
            const chaptersPerSecond = downloadProgress.current / elapsed
            const remainingChapters = downloadProgress.total - downloadProgress.current
            const remainingSeconds = remainingChapters / chaptersPerSecond
            
            if (remainingSeconds > 0) {
                const minutes = Math.floor(remainingSeconds / 60)
                const seconds = Math.floor(remainingSeconds % 60)
                document.getElementById('time-remaining').textContent = 
                    `${minutes}分${seconds}秒`
            }
        }
        
        // 等待恢复下载
        function waitForResume() {
            return new Promise(resolve => {
                const checkResume = setInterval(() => {
                    if (!isPaused || downloadProgress.isCancelled) {
                        clearInterval(checkResume)
                        resolve()
                    }
                }, 1000)
            })
        }
        
        // 取消下载
        function cancelDownload() {
            if (downloadProgress) {
                downloadProgress.cancel()
                isDownloading = false
                showNotification('下载已取消', 'info')
            }
        }
        
        // 暂停/继续下载
        function togglePauseDownload() {
            isPaused = !isPaused
            const pauseBtn = document.getElementById('progress-pause')
            if (isPaused) {
                pauseBtn.innerHTML = '<i class="fas fa-play"></i> 继续'
                pauseBtn.className = 'btn btn-success'
                showNotification('下载已暂停', 'info')
            } else {
                pauseBtn.innerHTML = '<i class="fas fa-pause"></i> 暂停'
                pauseBtn.className = 'btn btn-warning'
                showNotification('下载继续', 'info')
            }
        }
        
        // 手动保存
        function saveManually() {
            if (!window.downloadResult) {
                showNotification('没有可保存的内容', 'warning')
                return
            }
            
            const newWindow = window.open('', '_blank')
            if (newWindow) {
                newWindow.document.write(`
                    <html>
                    <head>
                        <title>${window.downloadResult.fileName}</title>
                        <style>
                            body {
                                font-family: 'Microsoft YaHei', sans-serif;
                                line-height: 1.8;
                                max-width: 800px;
                                margin: 0 auto;
                                padding: 20px;
                                background: #1e1e2e;
                                color: #cdd6f4;
                            }
                            pre {
                                white-space: pre-wrap;
                                word-wrap: break-word;
                                font-size: 16px;
                                line-height: 1.6;
                            }
                        </style>
                    </head>
                    <body>
                        <pre>${window.downloadResult.content}</pre>
                        <script>
                            window.onload = function() {
                                alert('请按 Ctrl+A 全选，然后按 Ctrl+C 复制，最后粘贴到文本编辑器中保存。');
                            }
                        <\/script>
                    </body>
                    </html>
                `)
                newWindow.document.close()
            }
        }
        
        // 重新下载
        function reDownloadFile() {
            if (!window.downloadResult || !window.downloadResult.blob) {
                showNotification('没有可重新下载的文件', 'warning')
                return
            }
            
            saveAs(window.downloadResult.blob, window.downloadResult.fileName)
            showNotification('正在重新下载文件', 'info')
        }
        
        // 隐藏进度窗口
        function hideProgressModal() {
            document.getElementById('progress-modal').style.display = 'none'
        }
        
        // 关闭进度窗口
        function closeProgressModal() {
            hideProgressModal()
            isDownloading = false
            isPaused = false
        }
        
        // 章节范围相关功能
        function showChapterRangeModal() {
            if (!currentCatalog || currentCatalog.length === 0) {
                showNotification('请先加载书籍目录', 'warning')
                return
            }
            
            const modal = document.getElementById('chapter-modal')
            modal.style.display = 'flex'
            
            // 设置当前值
            const startChapter = document.getElementById('start-chapter').value || '1'
            const endChapter = document.getElementById('end-chapter').value || currentCatalog.length.toString()
            
            document.getElementById('modal-start-chapter').value = startChapter
            document.getElementById('modal-end-chapter').value = endChapter
            
            // 更新预览
            updateChapterPreview(parseInt(startChapter), parseInt(endChapter))
        }
        
        function hideChapterModal() {
            document.getElementById('chapter-modal').style.display = 'none'
        }
        
        function updateChapterPreview(start, end) {
            const preview = document.getElementById('chapter-preview')
            const validStart = Math.max(1, start)
            const validEnd = Math.min(currentCatalog.length, end || currentCatalog.length)
            
            if (validStart > validEnd) {
                preview.innerHTML = '<p class="preview-error">开始章节不能大于结束章节</p>'
                return
            }
            
            const chapters = currentCatalog.slice(validStart - 1, validEnd)
            const previewHtml = chapters.slice(0, 5).map((chapter, index) => 
                `<div class="preview-item">${validStart + index}. ${chapter.title}</div>`
            ).join('')
            
            const moreText = chapters.length > 5 ? 
                `<div class="preview-more">... 等 ${chapters.length} 个章节</div>` : ''
            
            preview.innerHTML = previewHtml + moreText
        }
        
        function setChapterRange(start, end) {
            document.getElementById('modal-start-chapter').value = start
            document.getElementById('modal-end-chapter').value = end
            updateChapterPreview(start, end)
        }
        
        function selectAllChapters() {
            setChapterRange(1, currentCatalog.length)
        }
        
        function selectLatestChapters(count) {
            const start = Math.max(1, currentCatalog.length - count + 1)
            const end = currentCatalog.length
            setChapterRange(start, end)
        }
        
        function applyChapterRange() {
            const start = document.getElementById('modal-start-chapter').value
            const end = document.getElementById('modal-end-chapter').value
            
            document.getElementById('start-chapter').value = start
            document.getElementById('end-chapter').value = end
            
            hideChapterModal()
            showNotification('章节范围已更新', 'success')
        }
        
        function applyAndDownload() {
            applyChapterRange()
            hideChapterModal()
            setTimeout(() => downloadBook(), 300)
        }
        
        // 音频下载相关
        function showAudioModal() {
            document.getElementById('audio-modal').style.display = 'flex'
        }
        
        function hideAudioModal() {
            document.getElementById('audio-modal').style.display = 'none'
        }
        
        function startAudioDownload() {
            showNotification('音频下载功能正在开发中...', 'info')
            hideAudioModal()
        }
        
        // 下载历史相关
        function addToDownloadHistory(bookName, chapterCount) {
            const historyItem = {
                id: Date.now(),
                bookName,
                chapterCount,
                date: new Date().toISOString(),
                timestamp: Date.now()
            }
            
            downloadHistory.unshift(historyItem)
            if (downloadHistory.length > 10) {
                downloadHistory = downloadHistory.slice(0, 10)
            }
            
            localStorage.setItem('download_history', JSON.stringify(downloadHistory))
            updateHistoryList()
        }
        
        function updateHistoryList() {
            const historyList = document.getElementById('history-list')
            
            if (downloadHistory.length === 0) {
                historyList.innerHTML = '<p class="empty-history">暂无下载记录</p>'
                return
            }
            
            const historyHtml = downloadHistory.map(item => `
                <div class="history-item">
                    <div class="history-book">${item.bookName}</div>
                    <div class="history-details">
                        <span>${item.chapterCount}章</span>
                        <span>${moment(item.timestamp).format('MM-DD HH:mm')}</span>
                    </div>
                </div>
            `).join('')
            
            historyList.innerHTML = historyHtml
        }
        
        function clearDownloadHistory() {
            downloadHistory = []
            localStorage.setItem('download_history', '[]')
            updateHistoryList()
            showNotification('下载历史已清空', 'info')
        }
        
        // 书籍操作
        function showBookActions() {
            if (!currentBookData) return
            
            const actions = [
                { text: '查看详细信息', icon: 'info-circle', action: showBookDetails },
                { text: '复制书籍ID', icon: 'copy', action: copyBookId },
                { text: '打开源网站', icon: 'external-link-alt', action: openSourceSite },
                { text: '清除缓存', icon: 'broom', action: clearCache },
                { text: '导出设置', icon: 'cog', action: exportSettings }
            ]
            
            // 这里可以显示一个操作菜单
            showNotification('点击标题查看详细信息，或使用下方按钮操作', 'info')
        }
        
        function showBookDetails() {
            if (!currentBookData) {
                showNotification('请先选择一本书籍', 'warning')
                return
            }
            
            const dialog = document.getElementById('detail-dialog')
            const content = document.getElementById('detail-dialog-content')
            
            const details = `
                <div class="detail-info">
                    <h4>基础信息</h4>
                    <p><strong>书籍ID:</strong> ${document.getElementById('book_id').textContent}</p>
                    <p><strong>书名:</strong> ${currentBookData.book_name}</p>
                    <p><strong>作者:</strong> ${currentBookData.author}</p>
                    <p><strong>原始书名:</strong> ${currentBookData.original_book_name || '无'}</p>
                    <p><strong>字数:</strong> ${formatCount(currentBookData.word_number)}</p>
                    <p><strong>分类:</strong> ${currentBookData.category}</p>
                    <p><strong>标签:</strong> ${currentBookData.tags || '无'}</p>
                    <p><strong>状态:</strong> ${['未知', '完结', '连载'][currentBookData.creation_status || 0] || '未知'}</p>
                    
                    <h4>统计信息</h4>
                    <p><strong>读者数:</strong> ${formatCount(currentBookData.read_count)}</p>
                    <p><strong>听书人数:</strong> ${formatCount(currentBookData.listen_count)}</p>
                    <p><strong>加书架数:</strong> ${formatCount(currentBookData.shelf_cnt_history)}</p>
                    <p><strong>听书时长:</strong> ${formatDuration(currentBookData.duration || 0)}</p>
                    
                    <h4>其他信息</h4>
                    <p><strong>创建时间:</strong> ${moment(currentBookData.create_time).format('YYYY-MM-DD HH:mm:ss')}</p>
                    <p><strong>最新章节:</strong> ${currentBookData.last_chapter_title || '无'}</p>
                    <p><strong>最新章节时间:</strong> ${currentBookData.last_chapter_first_pass_time ? 
                        moment(parseInt(currentBookData.last_chapter_first_pass_time) * 1000).format('YYYY-MM-DD HH:mm:ss') : '无'}</p>
                    <p><strong>版权信息:</strong> ${currentBookData.copyright_info || '无'}</p>
                </div>
            `
            
            content.innerHTML = details
            dialog.showModal()
        }
        
        function copyBookId() {
            const bookId = document.getElementById('book_id').textContent
            if (bookId) {
                navigator.clipboard.writeText(bookId)
                showNotification('书籍ID已复制到剪贴板', 'success')
            }
        }
        
        function openSourceSite() {
            const bookId = document.getElementById('book_id').textContent
            if (bookId) {
                window.open(`https://fanqienovel.com/page/${bookId}`, '_blank')
            }
        }
        
        function clearCache() {
            localStorage.removeItem('download_history')
            downloadHistory = []
            updateHistoryList()
            showNotification('缓存已清除', 'success')
        }
        
        function exportSettings() {
            const settings = {
                theme: document.body.dataset.theme,
                downloadType: document.getElementById('type-selector').value,
                charset: document.getElementById('charset-selector').value,
                format: document.getElementById('format-selector').value,
                batchSize: document.getElementById('batch-size').value,
                lastUpdate: new Date().toISOString()
            }
            
            const dataStr = JSON.stringify(settings, null, 2)
            const dataBlob = new Blob([dataStr], { type: 'application/json' })
            saveAs(dataBlob, '夜樱书屋设置.json')
            showNotification('设置已导出', 'success')
        }
        
        // 清空书籍信息
        function clearBookInfo() {
            if (confirm('确定要清空当前书籍信息吗？')) {
                currentBookData = null
                currentCatalog = []
                document.getElementById('book-info').style.display = 'none'
                document.getElementById('book-list').innerHTML = ''
                document.getElementById('results-count').textContent = '0 本'
                showNotification('书籍信息已清空', 'info')
            }
        }
        
        // 格式化时长
        function formatDuration(seconds) {
            if (!seconds) return '0秒'
            const hours = Math.floor(seconds / 3600)
            const minutes = Math.floor((seconds % 3600) / 60)
            const secs = Math.floor(seconds % 60)
            
            if (hours > 0) {
                return `${hours}小时${minutes}分${secs}秒`
            } else if (minutes > 0) {
                return `${minutes}分${secs}秒`
            } else {
                return `${secs}秒`
            }
        }
        
        // URL参数管理
        function updateUrlParams(params) {
            const url = new URL(window.location.href)
            if (url.protocol === 'file:' || url.protocol === 'content:') return
            
            url.searchParams.delete('book_id')
            url.searchParams.delete('text')
            url.searchParams.delete('search_type')
            
            Object.keys(params).forEach(key => {
                if (params[key] !== null && params[key] !== undefined && params[key] !== '') {
                    url.searchParams.set(key, params[key])
                }
            })
            
            window.history.pushState({ path: url.href }, '', url.href)
        }
        
        function restoreFromUrlParams() {
            const url = new URL(window.location.href)
            const bookId = url.searchParams.get('book_id')
            const searchText = url.searchParams.get('text')
            
            if (searchText) {
                document.getElementById('book-search').value = searchText
                setTimeout(() => searchBooks(searchText), 500)
            } else if (bookId) {
                setTimeout(() => showBookInfo(bookId), 500)
            }
        }
        
        // API响应标准化
        function normalizeApiResponse(response) {
            return response
        }
        
        // 樱花飘落效果
        function createSakuraEffect() {
            const container = document.querySelector('.sakura-container')
            const sakuraCount = 15
            
            for (let i = 0; i < sakuraCount; i++) {
                const sakura = document.createElement('div')
                sakura.className = 'sakura'
                
                // 随机属性
                const size = Math.random() * 15 + 10
                const startX = Math.random() * 100
                const duration = Math.random() * 20 + 10
                const delay = Math.random() * 5
                
                sakura.style.width = `${size}px`
                sakura.style.height = `${size}px`
                sakura.style.left = `${startX}%`
                sakura.style.animationDuration = `${duration}s`
                sakura.style.animationDelay = `${delay}s`
                sakura.style.opacity = Math.random() * 0.5 + 0.3
                
                container.appendChild(sakura)
            }
        }
        
        console.log('夜樱书屋已启动 🌸')
    </script>

    <style>
        /* 重置样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* 粉黑色主题变量 */
            --bg-primary: #0f0b16;
            --bg-secondary: #1a1625;
            --bg-card: #221e2f;
            --bg-input: #2a2638;
            --bg-hover: #322d42;
            
            --text-primary: #e6e1f0;
            --text-secondary: #b8b2cc;
            --text-muted: #8a8499;
            
            --accent-pink: #ff6b9d;
            --accent-purple: #b399ff;
            --accent-blue: #6bb5ff;
            --accent-green: #4dccbd;
            --accent-red: #ff6b6b;
            --accent-yellow: #ffd166;
            
            --border-color: #3a3548;
            --shadow-color: rgba(0, 0, 0, 0.3);
            
            --gradient-primary: linear-gradient(135deg, #ff6b9d, #b399ff);
            --gradient-secondary: linear-gradient(135deg, #1a1625, #221e2f);
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', 'Hiragino Sans GB', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 10% 20%, rgba(255, 107, 157, 0.05) 0%, transparent 25%),
                radial-gradient(circle at 90% 80%, rgba(179, 153, 255, 0.05) 0%, transparent 25%),
                radial-gradient(circle at 50% 50%, rgba(107, 181, 255, 0.03) 0%, transparent 35%);
            pointer-events: none;
            z-index: -1;
        }
        
        /* 夜间模式遮罩 */
        .night-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(15, 11, 22, 0.9), rgba(26, 22, 37, 0.9));
            pointer-events: none;
            z-index: -1;
        }
        
        /* 樱花效果 */
        .sakura-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .sakura {
            position: absolute;
            background: linear-gradient(135deg, #ff6b9d, #ff9ec6);
            border-radius: 50% 50% 50% 0;
            transform: rotate(45deg);
            filter: blur(0.5px);
            animation: sakura-fall linear infinite;
        }
        
        @keyframes sakura-fall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.8;
            }
            90% {
                opacity: 0.8;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* 导航栏 */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        
        .nav-brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .nav-brand i {
            font-size: 2rem;
            color: var(--accent-pink);
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from {
                filter: drop-shadow(0 0 5px var(--accent-pink));
            }
            to {
                filter: drop-shadow(0 0 15px var(--accent-pink));
            }
        }
        
        .nav-brand h1 {
            font-size: 1.8rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }
        
        .theme-switch {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .theme-switch:hover {
            background: var(--bg-hover);
            transform: rotate(30deg);
            border-color: var(--accent-pink);
        }
        
        #sun-icon {
            color: var(--accent-yellow);
        }
        
        #moon-icon {
            color: var(--accent-purple);
        }
        
        /* 主容器 */
        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
        }
        
        /* 搜索区域 */
        .search-section {
            margin-bottom: 30px;
        }
        
        .search-card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 30px;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px var(--shadow-color);
        }
        
        .search-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
        }
        
        .search-icon {
            width: 60px;
            height: 60px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            box-shadow: 0 5px 15px rgba(255, 107, 157, 0.3);
        }
        
        .search-type-tabs {
            display: flex;
            gap: 10px;
            background: var(--bg-input);
            padding: 5px;
            border-radius: var(--radius-md);
        }
        
        .search-tab {
            padding: 12px 24px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
        }
        
        .search-tab:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .search-tab.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 107, 157, 0.3);
        }
        
        .search-main {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .search-input-wrapper {
            display: flex;
            gap: 15px;
        }
        
        .search-input {
            flex: 1;
            padding: 18px 25px;
            background: var(--bg-input);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            color: var(--text-primary);
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--accent-pink);
            box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.2);
        }
        
        .search-btn {
            padding: 18px 35px;
            background: var(--gradient-primary);
            border: none;
            border-radius: var(--radius-lg);
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 140px;
            justify-content: center;
        }
        
        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 107, 157, 0.4);
        }
        
        .search-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        
        /* 高级选项 */
        .advanced-options {
            background: var(--bg-input);
            border-radius: var(--radius-lg);
            padding: 25px;
            border: 1px solid var(--border-color);
        }
        
        .option-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .option-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .option-group label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .styled-select {
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .styled-select:focus {
            outline: none;
            border-color: var(--accent-pink);
        }
        
        .styled-select.small {
            padding: 8px 12px;
            font-size: 0.9rem;
        }
        
        /* 章节范围设置 */
        .chapter-range-section {
            border-top: 1px solid var(--border-color);
            padding-top: 25px;
        }
        
        .chapter-range-section h4 {
            color: var(--text-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .range-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .range-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .range-group label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .range-input {
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        
        .range-input:focus {
            outline: none;
            border-color: var(--accent-pink);
        }
        
        /* 内容区域 */
        .content-area {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 30px;
        }
        
        @media (max-width: 1200px) {
            .content-area {
                grid-template-columns: 1fr;
            }
        }
        
        /* 搜索结果区域 */
        .results-section {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            border: 1px solid var(--border-color);
            overflow: hidden;
            height: calc(100vh - 200px);
            display: flex;
            flex-direction: column;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .section-header h3 {
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .count-badge {
            background: var(--gradient-primary);
            color: white;
            padding: 6px 12px;
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        /* 书籍网格 */
        .books-grid {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .books-grid::-webkit-scrollbar {
            width: 8px;
        }
        
        .books-grid::-webkit-scrollbar-track {
            background: var(--bg-input);
            border-radius: 4px;
        }
        
        .books-grid::-webkit-scrollbar-thumb {
            background: var(--accent-pink);
            border-radius: 4px;
        }
        
        /* 书籍卡片 */
        .book-item {
            background: var(--bg-input);
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }
        
        .book-item:hover {
            transform: translateY(-5px);
            border-color: var(--accent-pink);
            box-shadow: 0 10px 25px rgba(255, 107, 157, 0.2);
        }
        
        .book-item-cover {
            height: 320px;
            position: relative;
            overflow: hidden;
        }
        
        .book-item-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .book-item:hover .book-item-cover img {
            transform: scale(1.05);
        }
        
        .book-rank {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--gradient-primary);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }
        
        .book-item-info {
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .book-item-title {
            font-size: 1.1rem;
            color: var(--text-primary);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .book-item-author {
            font-size: 0.95rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .book-item-meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .meta-tag {
            font-size: 0.8rem;
            padding: 4px 10px;
            background: var(--bg-card);
            color: var(--text-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        
        .meta-tag.readers {
            background: rgba(107, 181, 255, 0.1);
            color: var(--accent-blue);
            border-color: rgba(107, 181, 255, 0.3);
        }
        
        .book-item-action {
            margin-top: auto;
            padding: 10px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        
        .book-item-action:hover {
            background: var(--bg-hover);
            border-color: var(--accent-pink);
            color: var(--accent-pink);
        }
        
        /* 空状态 */
        .empty-results {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }
        
        .empty-results i {
            font-size: 4rem;
            color: var(--accent-pink);
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-results h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--text-secondary);
        }
        
        /* 详情区域 */
        .detail-section {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            border: 1px solid var(--border-color);
            overflow: hidden;
            display: none;
            height: calc(100vh - 200px);
        }
        
        .detail-card {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-header h2 {
            font-size: 1.8rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: color 0.3s ease;
            flex: 1;
            margin-right: 20px;
        }
        
        .detail-header h2:hover {
            color: var(--accent-pink);
        }
        
        .detail-action {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .detail-action:hover {
            background: var(--bg-hover);
            border-color: var(--accent-pink);
            color: var(--accent-pink);
            transform: rotate(90deg);
        }
        
        /* 详情内容 */
        .detail-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 30px;
        }
        
        .detail-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .detail-content::-webkit-scrollbar-track {
            background: var(--bg-input);
            border-radius: 4px;
        }
        
        .detail-content::-webkit-scrollbar-thumb {
            background: var(--accent-pink);
            border-radius: 4px;
        }
        
        /* 封面区域 */
        .cover-section {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .cover-container {
            position: relative;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .book-cover-large {
            width: 100%;
            height: 450px;
            object-fit: cover;
            display: block;
        }
        
        .cover-glow {
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: linear-gradient(45deg, transparent, rgba(255, 107, 157, 0.1), transparent);
            z-index: 1;
            pointer-events: none;
        }
        
        /* 操作按钮 */
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .action-btn {
            padding: 15px 20px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }
        
        .action-btn.primary {
            background: var(--gradient-primary);
            color: white;
        }
        
        .action-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 107, 157, 0.4);
        }
        
        .action-btn.secondary {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .action-btn.secondary:hover {
            background: var(--bg-hover);
            border-color: var(--accent-purple);
            color: var(--accent-purple);
        }
        
        .action-btn.danger {
            background: rgba(255, 107, 107, 0.1);
            color: var(--accent-red);
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        
        .action-btn.danger:hover {
            background: rgba(255, 107, 107, 0.2);
            border-color: var(--accent-red);
        }
        
        /* 信息区域 */
        .info-section {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            background: var(--bg-input);
            padding: 20px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .info-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .info-value {
            font-size: 1.1rem;
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .status-完结 {
            background: rgba(77, 204, 189, 0.2);
            color: var(--accent-green);
            border: 1px solid rgba(77, 204, 189, 0.3);
        }
        
        .status-连载 {
            background: rgba(255, 209, 102, 0.2);
            color: var(--accent-yellow);
            border: 1px solid rgba(255, 209, 102, 0.3);
        }
        
        .status-断更 {
            background: rgba(255, 107, 107, 0.2);
            color: var(--accent-red);
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        
        /* 盒子组件 */
        .latest-chapter-box,
        .description-box,
        .download-history {
            background: var(--bg-input);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        
        .box-header {
            padding: 18px 25px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .box-content {
            padding: 25px;
        }
        
        .chapter-title {
            font-size: 1.1rem;
            color: var(--text-primary);
            line-height: 1.5;
            margin-bottom: 10px;
        }
        
        .chapter-time {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .description-text {
            line-height: 1.8;
            color: var(--text-secondary);
        }
        
        .scrollable {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .scrollable::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollable::-webkit-scrollbar-track {
            background: var(--bg-card);
            border-radius: 3px;
        }
        
        .scrollable::-webkit-scrollbar-thumb {
            background: var(--accent-pink);
            border-radius: 3px;
        }
        
        /* 下载历史 */
        .clear-history {
            margin-left: auto;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.3s ease;
        }
        
        .clear-history:hover {
            color: var(--accent-red);
        }
        
        .history-content {
            min-height: 100px;
        }
        
        .empty-history {
            text-align: center;
            color: var(--text-muted);
            padding: 30px 0;
        }
        
        .history-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-book {
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 5px;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .history-details {
            display: flex;
            justify-content: space-between;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* 隐藏数据 */
        .hidden-data {
            display: none;
        }
        
        /* 弹窗遮罩 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 11, 22, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        /* 弹窗内容 */
        .modal-content {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            animation: modal-appear 0.3s ease;
        }
        
        .modal-content.large {
            max-width: 700px;
        }
        
        @keyframes modal-appear {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 25px 30px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .modal-header h3 {
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .modal-icon {
            width: 50px;
            height: 50px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            background: var(--bg-input);
            color: var(--accent-red);
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 30px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .modal-body::-webkit-scrollbar {
            width: 8px;
        }
        
        .modal-body::-webkit-scrollbar-track {
            background: var(--bg-input);
            border-radius: 4px;
        }
        
        .modal-body::-webkit-scrollbar-thumb {
            background: var(--accent-pink);
            border-radius: 4px;
        }
        
        .modal-footer {
            padding: 25px 30px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        
        /* 按钮样式 */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 107, 157, 0.4);
        }
        
        .btn-secondary {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--accent-purple);
            color: var(--accent-purple);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--accent-green), #76d7c4);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--accent-yellow), #ffb347);
            color: #333;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--accent-red), #ff8e8e);
            color: white;
        }
        
        /* 进度条 */
        .progress-section {
            margin-bottom: 25px;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        #progress-percentage {
            color: var(--accent-pink);
            font-weight: 600;
        }
        
        #progress-count {
            color: var(--text-secondary);
        }
        
        .progress-bar-wrapper {
            height: 12px;
            background: var(--bg-input);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .progress-bar-wrapper.small {
            height: 8px;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: var(--gradient-primary);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 6px;
        }
        
        .progress-details {
            display: flex;
            justify-content: space-between;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .sub-progress-section {
            background: var(--bg-input);
            padding: 20px;
            border-radius: var(--radius-lg);
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }
        
        .sub-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: var(--text-primary);
        }
        
        .sub-details {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 10px;
        }
        
        .chapter-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            background: var(--bg-input);
            padding: 20px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .stat-value {
            font-size: 1.2rem;
            color: var(--text-primary);
            font-weight: 600;
        }
        
        /* 章节范围控制 */
        .range-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .range-input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .range-input-group label {
            color: var(--text-primary);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .modal-range-input {
            padding: 14px 18px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .modal-range-input:focus {
            outline: none;
            border-color: var(--accent-pink);
        }
        
        .range-preview {
            background: var(--bg-input);
            padding: 20px;
            border-radius: var(--radius-lg);
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }
        
        .range-preview h4 {
            color: var(--text-primary);
            margin-bottom: 15px;
        }
        
        .preview-list {
            max-height: 150px;
            overflow-y: auto;
        }
        
        .preview-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .preview-list::-webkit-scrollbar-track {
            background: var(--bg-card);
            border-radius: 3px;
        }
        
        .preview-list::-webkit-scrollbar-thumb {
            background: var(--accent-pink);
            border-radius: 3px;
        }
        
        .preview-item {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .preview-item:last-child {
            border-bottom: none;
        }
        
        .preview-empty {
            text-align: center;
            color: var(--text-muted);
            padding: 20px 0;
        }
        
        .preview-error {
            color: var(--accent-red);
            text-align: center;
            padding: 20px 0;
        }
        
        .preview-more {
            text-align: center;
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 10px;
            font-style: italic;
        }
        
        .quick-ranges {
            margin-bottom: 20px;
        }
        
        .quick-ranges h4 {
            color: var(--text-primary);
            margin-bottom: 15px;
        }
        
        .quick-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .quick-btn {
            padding: 10px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .quick-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent-pink);
            color: var(--accent-pink);
        }
        
        /* 音频设置 */
        .audio-settings {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .setting-group label {
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .warning-box {
            background: rgba(255, 209, 102, 0.1);
            border: 1px solid rgba(255, 209, 102, 0.3);
            border-radius: var(--radius-md);
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--accent-yellow);
        }
        
        .warning-box i {
            font-size: 1.2rem;
        }
        
        /* 详情对话框 */
        .detail-dialog {
            border: none;
            border-radius: var(--radius-xl);
            padding: 0;
            width: 90%;
            max-width: 800px;
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }
        
        .detail-dialog::backdrop {
            background: rgba(15, 11, 22, 0.9);
            backdrop-filter: blur(10px);
        }
        
        .dialog-content {
            display: flex;
            flex-direction: column;
            max-height: 80vh;
        }
        
        .dialog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .dialog-header h3 {
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .dialog-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .dialog-close:hover {
            background: var(--bg-input);
            color: var(--accent-red);
            transform: rotate(90deg);
        }
        
        .dialog-body {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }
        
        .detail-info h4 {
            color: var(--accent-pink);
            margin: 25px 0 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-info p {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .detail-info strong {
            color: var(--text-primary);
            margin-right: 8px;
        }
        
        /* 通知容器 */
        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .notification {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 15px 20px;
            border-left: 4px solid var(--accent-pink);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification-info {
            border-left-color: var(--accent-blue);
        }
        
        .notification-success {
            border-left-color: var(--accent-green);
        }
        
        .notification-warning {
            border-left-color: var(--accent-yellow);
        }
        
        .notification-error {
            border-left-color: var(--accent-red);
        }
        
        .notification i {
            font-size: 1.2rem;
        }
        
        .notification-info i {
            color: var(--accent-blue);
        }
        
        .notification-success i {
            color: var(--accent-green);
        }
        
        .notification-warning i {
            color: var(--accent-yellow);
        }
        
        .notification-error i {
            color: var(--accent-red);
        }
        
        /* 响应式设计 */
        @media (max-width: 1200px) {
            .detail-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .cover-section {
                max-width: 400px;
                margin: 0 auto;
            }
        }
        
        @media (max-width: 992px) {
            .navbar {
                padding: 15px 20px;
            }
            
            .main-container {
                padding: 20px;
            }
            
            .search-input-wrapper {
                flex-direction: column;
            }
            
            .search-btn {
                width: 100%;
            }
            
            .option-row {
                grid-template-columns: 1fr;
            }
            
            .range-inputs {
                grid-template-columns: 1fr;
            }
            
            .range-controls {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .books-grid {
                grid-template-columns: 1fr;
            }
            
            .book-item-cover {
                height: 280px;
            }
            
            .book-cover-large {
                height: 380px;
            }
            
            .modal-content {
                width: 95%;
                margin: 10px;
            }
            
            .modal-footer {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .quick-buttons {
                justify-content: center;
            }
            
            .modal-header h3 {
                font-size: 1.2rem;
            }
            
            .section-header h3 {
                font-size: 1.1rem;
            }
        }
        
        @media (max-width: 576px) {
            .nav-brand h1 {
                font-size: 1.4rem;
            }
            
            .search-card {
                padding: 20px;
            }
            
            .search-icon {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
        
            .book-item-cover {
                height: 240px;
            }
            
            .book-cover-large {
                height: 340px;
            }
            
            .detail-header h2 {
                font-size: 1.4rem;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .chapter-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .notification {
                min-width: 250px;
                padding: 12px 16px;
            }
        }
        
        /* 动画效果 */
        .fade-in {
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }
        
        /* 加载动画 */
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-pink);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</body>
</html>